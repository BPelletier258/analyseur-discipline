<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analyseur Discipline — Filtrage par article</title>
  {{ css|safe }}

  <style>
    /* Overlay (sablier) */
    .overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.75);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 56px; height: 56px; border-radius: 50%;
      border: 5px solid #93c5fd; border-top-color: #1d4ed8;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Formulaire : 1) Article (large) 2) Fichier (large) 3) Bouton (étroit) */
    .formgrid{
      display:grid;
      grid-template-columns: 1fr 560px 120px;
      gap:12px;
      align-items:end;
    }
    .formcol{display:flex;flex-direction:column;gap:8px}

    /* Ligne fichier */
    .file-row{ display:flex; gap:10px; align-items:center; min-width:0; }
    input[type="file"]{ max-width:100%; }

    /* Nom de fichier rouge + ellipsis + tooltip */
    .file-name{
      color:#dc2626; font-weight:700;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      flex:1; min-width:0;
    }

    .btn-download {
      display:inline-block; background:#0ea5e9; color:#fff; text-decoration:none;
      padding:10px 16px; border-radius:10px; font-weight:700;
    }
    .btn-download[disabled]{
      opacity:.65; pointer-events:none;
    }

    .err { color:#dc2626; margin:8px 0 0 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Analyseur Discipline – Filtrage par article</h1>

    <div class="note">
      <strong>Règles :</strong> détection exacte de l’article. Si la 1<sup>re</sup> cellule contient
      « <code>Article filtré :</code> », on ignore la 1<sup>re</sup> ligne (lignes d’en-têtes sur la 2<sup>e</sup>).
    </div>

    {% if error %}
      <p class="err">{{ error }}</p>
    {% endif %}

    <form class="formbar" action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data" id="analyzeForm">
      <div class="formgrid">
        <!-- Colonne 1 : Article -->
        <div class="formcol" style="grid-column:1;">
          <label for="article">Article à rechercher (ex. <em>29, 59(2)</em>)</label>
          <input type="text" name="article" id="article" value="{{ article }}" placeholder="29, 59(2)" required />

          <label style="display:flex;gap:8px;align-items:center;margin-top:6px;">
            <input type="checkbox" name="only_segment" id="only_segment" value="1"
                   {% if only_segment %}checked{% endif %} />
            Afficher uniquement le segment contenant l’article dans les 4 colonnes d’intérêt
          </label>

          <div style="font-size:12px; color:#475569; margin-top:4px;">
            Formats : <code>.xlsx</code> / <code>.xlsm</code>
          </div>
        </div>

        <!-- Colonne 2 : Fichier -->
        <div class="formcol" style="grid-column:2;">
          <label for="file">Fichier Excel</label>
          <div class="file-row">
            <input type="file" name="file" id="file" required />
            <span id="fileName" class="file-name" title="aucun fichier sélectionné">aucun fichier sélectionné</span>
          </div>
        </div>

        <!-- Colonne 3 : Bouton -->
        <div class="formcol" style="grid-column:3;">
          <label>&nbsp;</label>
          <button type="submit">Analyser</button>
        </div>
      </div>
    </form>

    <!-- Bouton de téléchargement : seulement si on a des résultats ET un Excel prêt -->
    {% if html_table %}
  {% if has_excel %}
    <a id="dlBtn"
       class="btn-download{% if download_disabled %} is-disabled{% endif %}"
       href="{{ url_for('download') }}"
       {% if download_disabled %}aria-disabled="true" tabindex="-1"{% endif %}>
       {% if download_disabled %}Téléchargement…{% else %}Télécharger le résultat (Excel){% endif %}
    </a>
    {% if download_disabled %}
      <div class="muted small" style="margin-top:6px">
        Fichier téléchargé. Relancez <strong>Analyser</strong> pour générer un nouveau fichier.
      </div>
    {% endif %}
  {% endif %}
{% endif %}

    <!-- Tableau HTML -->
    <div id="results">
      {% if html_table %}
        {{ html_table|safe }}
      {% endif %}
    </div>
  </div>

  <!-- Overlay (sablier) -->
  <div class="overlay" id="busyOverlay">
    <div class="spinner" aria-label="Analyse en cours…"></div>
  </div>

  <script>
    (function () {
      const form      = document.getElementById('analyzeForm');
      const overlay   = document.getElementById('busyOverlay');
      const fileInput = document.getElementById('file');
      const fileName  = document.getElementById('fileName');
      const btnDl     = document.getElementById('btnDownload');

      function refreshFileName() {
        if (fileInput.files && fileInput.files.length) {
          fileName.textContent = fileInput.files[0].name;
          fileName.title = fileInput.files[0].name;
        } else {
          fileName.textContent = 'aucun fichier sélectionné';
          fileName.title = 'aucun fichier sélectionné';
        }
      }
      fileInput.addEventListener('change', refreshFileName);
      refreshFileName();

      // Sablier pendant l'analyse
      form.addEventListener('submit', function () {
        overlay.style.display = 'flex';
      });

      // Désactiver le bouton après clic (pour éviter double-téléchargement)
      if (btnDl) {
        btnDl.addEventListener('click', function () {
          btnDl.setAttribute('disabled', 'disabled');
          btnDl.textContent = 'Téléchargement…';
          // Laisser le navigateur faire le download, le bouton reste inhibé
        });
      }
    })();
  </script>
</body>
</html>
